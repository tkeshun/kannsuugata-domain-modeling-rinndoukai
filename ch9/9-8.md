## 9.8 組み立てられたパイプライン

断片的にコードが示されてきたので、パイプライン全体がどのように組み立てられるか（記述されるか）を示す

- とはいえ長すぎるので、流れが理解できる程度にかいつまんで示す
- ファイル全体を見たい場合は[PlaceOrder.Implementation(without effects).fs](<https://github.com/swlaschin/DomainModelingMadeFunctional/blob/master/src/OrderTaking/PlaceOrder.Implementation(without%20effects).fs>)を参照する
  - エフェクト（Result や Async）を使った実装は[PlaceOrder.Implementation.fs](https://github.com/swlaschin/DomainModelingMadeFunctional/blob/master/src/OrderTaking/PlaceOrder.Implementation.fs)を参照する

```go
package placeorderworkflow

import (
	// 共通の単純型（String50や製品コードなど）を利用できるようにする
	// NOTE: Common.SimpleTypes.fs
	"simpletype"
	// 呼び出し元に公開されるパプリック型を利用できるようにする
	// NOTE: PlaceOrder.Api.fs
	"api"
)


// ======================================================
// パート1: 設計
//
// NOTE: ファイルの一番上に型定義を書く
// ======================================================

// ワークフローのパプリックな部分（API）は、
// `PlaceOrderWorkflow`関数やその入力である`UnvalidatedOrder`のように
// 別の場所で定義されている
// 以下の型はワークフロー実装に対しプライベートである

// ----- 注文の検証 -----
type CheckProductCodeExists func(productCode simpletype.ProductCode) bool // NOTE: 関数の型

type CheckedAddress of api.UnvalidatedAddress // NOTE: 型

type CheckAddressExists func(address api.UnvalidatedAddress) CheckedAddress // NOTE: 関数の型

type ValidateOrder func(
	checkProductCodeExists CheckProductCodeExists, // 依存関係
	checkAddressExists CheckAddressExists, // 依存関係
	order api.UnvalidatedOrder, // 入力
) ValidatedOrder // 出力


// ===============================
// パート2: 実装
//
// NOTE: 各ステップの実装を書く
// ===============================

// --------------------------------
// 注文の検証: 実装
// --------------------------------
func toCustomerInfo(unvalidatedCustomerInfo api.UnvalidatedCustomerInfo) api.CustomerInfo {
	...
}

func toAddress(checkAddressExists CheckAddressExists, unvalidatedAddress api.UnvalidatedAddress) CheckedAddress {
	...
}

...

func ValidateOrder func(
	checkProductCodeExists CheckProductCodeExists,
	checkAddressExists CheckAddressExists,
	order api.UnvalidatedOrder,
) ValidatedOrder {
	orderId := ...

	...
}


// --------------------------------
// ワークフローの全体像
//
// NTOE: 各ステップの実装を組み合わせて、メインのワークフロー関数を作成する
// --------------------------------

func PlaceOrder(
	checkProductCodeExists CheckProductCodeExists, // 依存関係
	checkAddressExists CheckAddressExists, // 依存関係
	getProductPrice GetProductPrice, // 依存関係
	createOrderAcknowledgmentLetter CreateOrderAcknowledgmentLetter, // 依存関係
	sendOrderAcknowledgment SendOrderAcknowledgment, // 依存関係
) func(api.UnvalidatedOrder) []api.OrderEvent { // 関数の定義

	return func(unvalidatedOrder api.UnvalidatedOrder) []api.OrderEvent {
		validatedOrder := ValidateOrder(checkProductCodeExists, checkAddressExists, unvalidatedOrder)
		pricedOrder := PriceOrder(validatedOrder, getProductPrice)
		acknowledgmentOption := acknowledgeOrder(pricedOrder, createOrderAcknowledgmentLetter, sendOrderAcknowledgment)
		events := createEvents(pricedOrder, acknowledgmentOption)
		return events
	}
}

```
