## 3.2 境界づけられたコンテキストのコミュニケーション
#### 「イベント」の使用
境界づけられたコンテキストは、「イベント」を使用してコミュニケーションを行う  

![](img\img2.dio.svg)

* 受注コンテキストの`注文確定`ワークフローは`注文が確定した`イベントを発行する
* `注文が確定した`イベントはキューに格納 or その他の方法で発行される
* 発送コンテキストは`注文が確定した`イベントをリッスンする
* イベント受信すると、`注文を発送する`コマンドが作成される
* `注文を発送る`コマンドは`注文発送`ワークフローを開始する
* `注文発送`ワークフローが正常に終了すると、`注文が発送された`イベントを発行する

イベントを通じてのみコミュニケーションを取っており、上流（＝受注）と下流（＝発送）のコンポーネントはお互いを意識せずに済む  
真に<u>自律的</u>なコンポーネントを実現するにはこのような疎結合が重要となる  

※個人の感想  
本の記載では「コンポーネント」「コンテキスト」「サブシステム」が混在しているが、この節の文脈においてはいずれも"境界"を指している想定

#### イベントを送信するための具体的なメカニズム
選択されたアーキテクチャによって異なる
* キューを利用した方法  
  マイクロサービスやエージェントを使ったアーキテクチャなど  
* 関数呼び出しで直接つなげる  
  モノリシックなアーキテクチャなど

イベントとコマンドの結合をどこで行いたいかによっても異なる  

### 3.2.1 境界づけられたコンテキスト間のデータ転送
コンテキスト間のコミュニケーションに使用されるイベントは、下流のコンポーネントがイベントを処理するために必要なすべてのデータを含む  

例えば、
* `注文が確定した`イベントには確定した注文内容が含まれる  
* これにより、`注文を発送する`コマンドを作成するために必要な情報を得ることができる  

渡されるデータオブジェクトはコンテキスト間のインフラストラクチャの一部としてシリアライズされ共有できるように設計されている  
※境界づけられたコンテキスト内で使用されていたデータオブジェクトと表面的には似ているが、別コンテキストで読み取れる形式に最適化されているものを指す

上記のようなデータ転送に使用されるオブジェクトを、本著では<u>データ転送オブジェクト(DTO)</u>と呼ぶ  

[上流コンテキストでのデータ転送]

![](img\img3.dio.svg)

上流のコンテキストの境界で、ドメインオブジェクトはDTOに変換→DTOはJSONやXMLの形式に変換される

[下流コンテキストでのデータ受け取り]

![](img\img4.dio.svg)

下流のコンテキストでは上流のコンテキストの流れを逆向きに実施する  
JSONやXMLはDTOにデシリアライズされ、ドメインオブジェクトに変換される  

### 3.2.2 信頼の境界線と検証  
境界づけられたコンテキストの境界線は、「信頼の境界線」として機能する  
* 境界線の内側　➡　信頼できる
* 境界線の外側　➡　信頼できない  

※個人的感想  
コンテキストは疎結合であるため、それ単体として自律はしているが、境界を超えた先は無関係  

そのため、ワークフローの最初と最後に「ゲート」を追加し、信頼できる内側と信頼できない外側を仲介させる必要がある  

![](img\img5.dio.svg)

#### 入力ゲートの役割
入力がドメインモデルの制約に適合しているか<u>常に</u>検証する 

例）
* `注文`オブジェクトのとあるプロパティは、非nullで50文字以内という制約がある
* 入力される`注文`DTOには上記のような制約がない

➡ 入力ゲートの検証を通過できる場合は有効  
➡ 通過できない場合はエラー    

#### 出力ゲートの役割  
境界づけられたコンテキストの外にプライベートな情報が漏れないようにする  
理由は以下  

* コンテキスト間の偶発的な結合を避けるのため  
* セキュリティのため  

例)  
* `注文`にはカードの番号が必要
* `発送`にはカードの番号は不要  

➡ ドメインオブジェクトをDTOに変換する過程で情報を意図的に落とす  