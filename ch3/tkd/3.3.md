# 3.3　境界付けられたコンテキスト間の契約

境界付けられたコンテキスト間の結合を低減したい
→しかし、コンテキスト間がやりとりできる→コミュニケーションのフォーマットを共有してる

コミュニケーションのフォーマットを共有する→何らかの結合が生じる

![](fig/if.drawio.svg)

## 結合の種類

- 共有カーネル　
    共通のドメイン設計を共有してる  
    ※クラスの継承や共有パッケージの利用がイメージに近い  

- 顧客/供給者（コンシューマ駆動契約）
    下流のコンテキストが上流のコンテキストに提供してほしい契約を定義する  
    契約（フォーマット）を守る限り、各ドメインは独立して発展できる  
    ※protoファイルによるコード生成とかイメージ近い？クライアントは実装については感知せず、ほしい処理を書いておく。サーバー側がそれを実装する  
    Goのinterfaceとかも近いかも  
    Goのtipsとして、interfaceを引数に、実体を返り値にするというものがある。欲しい物をinterfaceで定義しておいて、満たしてれば受け入れる  
    https://100go.co/ja/#6

- 順応者
    コンシューマ駆動の逆
    上流のコンテキストが提供する契約を受け入れ、自身のドメインモデルを調整する  
    ※外部APIを使うケースが近いイメージ

全体像
![](fig/contract.drawio.svg)

## 3.3.1 腐敗防止層

外部システムのモデルがドメインモデルと一致しないことがある  
外部システムにドメインモデルを変えて対応→「腐敗」
腐敗を防ぐためには？→境界付けられたコンテキスト内での使用に適したものに変換する
外部システムに合わせるのではなく、自分たちのドメインモデルと一致するように変換する
コンテキスト間の疎結合の追加を、DDDの用語で**腐敗防止層**と呼ぶ  

主な目的
❌ 検証を実施したりデータ破損を防止したりすること
⭕ 2 つの異なるコンテキストの翻訳者として機能（コンテキスト間の語彙の翻訳）

※↓アーキテクチャパターンとしてもある
腐敗防止層パターン（AWS Prescriptive Guidanceより）
> 上流チームが確立した通信契約を利用する前に、上流の境界付きコンテキスト (モノリス) のモデルを下流の境界付きコンテキスト (マイクロサービス) に適したモデルに変換  

https://docs.aws.amazon.com/ja_jp/prescriptive-guidance/latest/cloud-design-patterns/acl.html

## 3.3.2 関係を記述したコンテキストマップ

決定したコンテキスト間の関係
- 受注・発送→共有カーネル  
- 注文処理（受注）と請求管理（請求）はコンシューマー駆動、注文処理が供給者、請求管理が顧客  
- 製品カタログは順応者  
- 外部のアドレスチェックサービス→腐敗防止層を挟む


コンテキストの関係は以下のようなコンテキストマップで表せられる。
※少し加筆してあります  
![](fig/contextmap.drawio.svg)

