### 4.5 型の合成によるドメインモデルの構築

* 合成可能な型システムは、ドメインモデルを構築するための強力なツール
* Eコマースサイトのドメインモデルを構築するための設計例

> F#の型を使ってドメインモデルを構築する

```F#
// 小切手番号
type CheckNumber = CheckNumber of int
// カード番号
type CardNumber = CardNumber of string
// カードの種類 (OR型)
type CardType = Visa | MasterCard
// カード情報 (AND型)
type CreditCardInfo = { CardType: CardType; CardNumber: CardNumber }
// 支払い手段
type PaymentMethod = Cash | Check of CheckNumber | Card of CreditCardInfo

// 支払い総額
type PaymentAmount = PaymentAmount of decimal
// 通貨
type Currency = USD | EUR

// 支払い
type Payment = { Amount: PaymentAmount; Currency: Currency; Method: PaymentMethod }

// 未払いの請求書があり、さらに支払いがあれば、支払い済み請求書を作れます
type PayInvoice = UnpaidInvoice -> Payment -> PaidInvoice

// 支払い通貨から別の通貨に変換する
type ConvertPaymentCurrency = Payment -> Currency -> Payment
```

> Goの型を使ってドメインモデルを構築する

```go
package main

// CheckNumber 小切手番号
type CheckNumber int
// CardNumber カード番号
type CardNumber string
// CardType カードの種類(OR型)
type CardType int
// CardTypeの定数
// iotaは連番を生成する (コンパイル時に決まるっぽい)
// ↑のためDBに保存するときには使わない方がいい
// https://speakerdeck.com/uji/5fen-dewan-quan-li-jie-surugofalseiota?slide=21
const (
	Visa       CardType = iota // 0
	MasterCard                 // 1
)

// CreditCardInfo カード情報(構造体)
type CreditCardInfo struct {
	CardType   CardType
	CardNumber CardNumber
}

// PaymentMethod 支払い方法
type PaymentMethod interface{}
type (
	Cash  struct{}
	Check struct{ Number CheckNumber }
	Card  struct{ Info CreditCardInfo }
)

// PaymentAmount 支払い総額
type PaymentAmount float64

// Currency 通貨
type Currency int

const (
	USD Currency = iota
	EUR
)

// Payment 支払い
type Payment struct {
	Amount   PaymentAmount
	Currency Currency
	Method   PaymentMethod
}

// UnpaidInvoice 未払い請求書
type UnpaidInvoice struct{}

// PaidInvoice 支払い済み請求書
type PaidInvoice struct{}

// PayInvoice 支払い
// 未払い請求書と支払いを受け取り、支払い済み請求書を返す
type PayInvoice func(UnpaidInvoice, Payment) PaidInvoice

// ConvertPaymentCurrency 通貨変換
// 支払いと通貨を受け取り、通貨を変換した支払いを返す
type ConvertPaymentCurrency func(Payment, Currency) Payment
```
