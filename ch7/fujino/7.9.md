## 7.9 長時間動作するワークフロー

これまでのパイプラインは数秒程度の短い想定でした。
時間がかかるようなリモートサービスの呼び出があるといってもちょっとapiを叩くくらいですね。  
もし各ステップに数時間、数日かかるような場合、どのような構成にすればいいでしょうか？

```mermaid
flowchart LR
    開始 --> ステップ1
    ステップ1 -->|呼び出し| リモートサービス1[リモートサービス]
    リモートサービス1 -->|応答待ち| ステップ2
    ステップ2 -->|呼び出し| リモートサービス2[リモートサービス]
    リモートサービス2 -->|応答待ち| ステップ3
    ステップ3 --> 終了

    ステップ1 -->|状態を保存| ストレージ1[ストレージ]
    ストレージ1 -->|状態を再読み込み| ステップ2
    ステップ2 -->|状態を保存| ストレージ2[ストレージ]
    ストレージ2 -->|状態を再読み込み| ステップ3
```

新規に以下の作業が必要となります。
- ステップの状態管理
- 障害発生時のリカバリー定義

ステップの状態を永続化することで、各ステップが独立したプロセスとなり、それこそ別のサーバーで動いていても問題ありません。
また、それぞれが別のプロセスで実行するということは１つのトランザクションで実行できないということです。そのため、失敗時のリカバリー方法を前もって定義しておく必要があります。
例えば、失敗時には再実行するのか、逆の処理を実行して元に戻すのか、などです。
このようなワークフローを**Saga**と呼びます。

```mermaid
flowchart LR
    %% External Services
    subgraph ExternalServices[外部サービス]
        direction TB
        pricing[価格設定サービス]
        address[アドレス検証]
    end

    %% Storage
    storage[(ストレージ)]

    %% Core Processing Unit
    subgraph CoreProcess[コアプロセス]
        direction LR
        handler[イベントハンドラー]

        subgraph Tasks[タスク]
          direction LR
          orderVerify[注文の検証]
          orderCalc[注文の価格計算]
          other[その他処理]
        end

        handler --> orderVerify
        handler --> orderCalc
        handler --> other
    end

    %% Connections with External Services
    orderVerify -->|呼び出し| address
    orderCalc -->|呼び出し| pricing
    address -->|応答| handler
    pricing -->|応答| handler

    %% Storage Connections
    CoreProcess -->|状態を保存| storage
    storage -->|状態を再読み込み| handler
```

今回の例はシンプルですが、もしよりイベントや状態の数が増え複雑になった場合は、**プロセスマネージャ**というものが必要かもしれません。

Sagaではあくまでイベントによりどの処理を実行するかを決定します。それに対してプロセスマネージャーはイベントだけでなく、現在の状態に基づいて次の処理を決定します。


参考
- https://vasters.com/archive/Sagas.html
- https://learn.microsoft.com/ja-jp/azure/architecture/patterns/saga